# Tutorial 1. Assessing the adequacy of phylodynamic models in Ebola

Written by Sebastian Duchene
4 July 2017

## Requirements

In this tutorial we will assess the adequacy of models that describe branching process of phylogenetic trees. We will focus on the Birth-Death Skyline, Coalescent Exponential, and Constant-size coalescent. To do this, we will use the Tree Model Adequacy (TMA) package in BEAST2. To install please follow the instructions [here](https://github.com/sebastianduchene/tree_model_adequacy/wiki). We will also use [FigTree](http://beast.bio.ed.ac.uk/figtree), [Tracer](http://beast.bio.ed.ac.uk/tracer), and [R](https://www.r-project.org/) to visualise the results.

## Background

The TMA package is used to assess the adequacy of tree branching models. Model adequacy differs from model selection methods in that the goal is not to select the best model from a set of competing models, but to determine whether the data at hand could have been generated by a given model. In this respect, the model is treated as a hypothesis that can be rejected on some statistical grounds. In the context of branching models, we can use model adequacy to determine whether the tree shape that we observe in an empirical tree could have been generated by a constant Birth-Death process. This is important to interpret the inferences from the model and to obtain better insight about the biological process that generated the data. For the purpose of tree model adequacy, we will treat the phylogenetic tree with branch lengths in units of time (i.e. a chronogram) as the "empirical data".

Bayesian model adequacy consists of analysing the data under the model in question to estimate the posterior. The posterior is then used to simulate data sets, which represent hypothetical future observations under the model, and which are known as *posterior predictive simulations*. The model is considered adequate if the posterior predictive simulations are similar to the empirical data according to some test statistic. The choice of test statistic can be driven by some expectation about the model. For example, the exponential-growth coalescent model typically generates trees with long external branches (for population sizes that are increasing exponentially), such that the ratio of external to internal branch lengths is a useful test statistic. Similarly, the Birth-Death model with sampling explicitly models the sampling process through time, so we could also use the sampling times (i.e. ages of the tips) as a test statistic. The values of the test statistic from the posterior predictive simulations represent the expectation of values under the model, which is known as the *posterior predictive distribution*. The posterior predictive model adequacy framework is outlined in **Fig. 1**.

[INSERT FIGURE HERE]
**Fig. 1** Posterior predictive model adequacy.

## Obtaining the data

We will use a tree that was estimated for Ebola samples collected in West Africa at the early stages of the 2013-2015 outbreak. Please download the tree [here]().

Open the tree in FigTree by double-clicking on it. Otherwise, open FigTree and go to **File**, **Open**, and find the tree. The display should look like **Fig 2**.

[INSERT FIGURE HERE]
**Fig. 2** Ebola tree for West African samples collected in 2014. The branch lengths and scale bar are in units of years.

We will also need some MASTER templates, which can be downloaded [here](PATH TO MASTER TEMPLATES).

## Assessing adequacy of the constant size coalescent in Ebola virus

1. We will use BEAUTI to set up the tree model adequacy analysis. Open BEAUTI, and click **File**, **Template** and select **TreeModelAdequacy** (see **FIg. 3**). If you do not see this menu, please check that the TMA package and its dependencies are correctly [installed](https://github.com/sebastianduchene/tree_model_adequacy/wiki).

[INSERT FIGURE]
**Fig. 3** Selecting the **TreeModelAdequacy** template in BEAUTI.

2. After the **TreeModelAdequacy** template is loaded, you should see three tabs at the top of the BEAUTI window; **Partitions**, **Priors**, and **MCMC**. Click on **File** and **Import Fixed Tree**. Find the Ebola virus tree downloaded above. and click **Open**. You should see that the tree is loaded as shown in **Fig. 4**.

[INSERT FIGURE]
 **Fig. 4** Ebola virus tree loaded in BEAUTI.

 3. Now we need to set up the model to assess. We will set up the constant size coalescent first. To do this, click on the **Priors** tab and ensure that the **Coalescent Constant Population** is chosen. This model assumes that the virus population has been constant over time, and its only parameter is the effective population size (referred to as popSize in BEAST). In the context of an infectious disease, the effective population size is the number of infected hosts ($\phi$) divided by the coalescent rate ($\lambda$) times 2:

\[
 popSize = \frac{\phi}{2\lambda}
\]

The default prior and initial value are fine for this analysis.

4. Select the **MCMC** tab. You should see the display on **Fig. 5**.


[INSERT FIGURE 5 HERE]
**Fig. 5** MCMC display in BEAUTI.

5. There are several options that we need to set to conduct the analysis (**Fig. 6**):


**Fig. 6** TMA MCMC set up in BEAUTI.

  >- **Nr Of Trees** This is the number of posterior predictive simulations, which are trees simulated under the constant size coalescent. The effective population size parameter used to generate the trees will be sampled from the posterior PopSize parameter from the Ebola virus tree (i.e. the empirical tree). Set this option to 100.

  >- **Rootdir** The directory where we will store the posterior predictive simulations and BEAST xml scripts used to generate them. Type *tmp_CC* here to make a file in the current directory to save the output from the constant size coalescent.

  >- **Value**, **Hosts**, and **Do Not Run** are options to obtain the posterior predictive simulations independently from the MCMC of the empirical data. Ignore them for now, and in a later tutorial we will demonstrate how to set these up.

  >- **Burn in Percentage** The posterior predictive simulations will be obtained taking 100 random samples from the stationary distribution of the MCMC, such that we need to discard the burn-in. For this tutorial, we will discard 10% of the chain. Set this value to 10.

  >- **Master** TMA requires an xml template that it will use to generate the posterior predictive simulations. The template should match the model set up in the **Priors** tab, which is the constant size coalescent in this example. Click on **browse** and select a the file called **CC_hetero_sim.xml**, which you would have [downloaded above](PATH TO MASTER TEMPLATES).

  >- **Edit statistics** In this option we can select from a large range of tree statistics. Select a test statistic and use the green arrow to drag it from the left to the right column. Test statistics in the right column will be computed in the analysis. For this example, select *Tree Height*, *Time of maximum lineages*, *Slope ratio for LTT plot*, *Colless tree-imbalance*, and *External/Internal ratio* (**Fig. 7**). Click OK.

[INSERT FIGURE 7 HERE]
  **Fig. 7** Selecting tree statistics in BEAUTI.

  >- **Out** This is the name of the output file where we will store the posterior predictive distributions of the tests statistics defined above. Click browse and select a location (such as your Desktop), and call the file **out_cc.log**.

  >- **Chain Length** This is the length of the MCMC chain. For this analysis 10,000,000 steps is sufficient.

  >- Leave the remaining default settings and go to **File**, **Save As**, and save it in a directory that is easy to find. Call the file **ebola_CC.xml**.

6. We are now ready to run BEAST. Open BEAST by double clicking the icon. You should see a window like that in **Fig. 8**. Click **Choose File...** and select the **ebola_CC.xml** file. The rest of the options are fine for now. Click **Run**.

[INSERT FIGURE 8 HERE]

7. BEAST will now start running. It will conduct the following steps:

  >- Estimate the effective population size (PopSize) under the constant size coalescent. This MCMC will run for 10,000,000 steps.

  >- Sample 100 random values from the chain, after discarding 10% of burn-in.

  >- Use the samples from the previous steps to generate 100 trees, stored in **tmp_CC**. These are the posterior predictive simulations. To generate them, BEAST will read the MASTER template defined in step **5.1**, above.

  >- For each posterior predictive simulation, calculate *Tree Height*, *Time of maximum lineages*, *Slope ratio for LTT plot*, *Colless tree-imbalance*, and *External/Internal ratio*. These test statistics are also calculated for the empirical tree. They will be stored in **out_cc.log**, where the first row contains the tests statistics for the empirical tree, and the rest are for the posterior predictive simulations.

  8. After BEAST has run, a table will appear at the end of the run. It contains the *P* values for the test statistics and quantiles. The *P* value might vary slightly because we have only obtained 100 posterior predictive simulations, but they will give us a reasonable overview of the performance of this model (in practice we might want to obtain some 1000 posterior predictive simulations). In my analysis, the *P* values are; 0.06 for *Tree Height*, 0.76 for *Time of maximum lineages*, 0.96 for *Slope ratio for LTT plot*, 0.95 for *Colless tree imbalance* and 0.99 for *External/Internal ratio*. If the model is adequate, we expect that the test statistic for the empirical data should fall somewhere in the centre of the posterior predictive distribution for a given test statistic (*P* value of around 0.5). We could also use a frequentist approach to determine that *P* should range between 0.05 and 0.95 for an adequate model according to a given test statistic. In this case, the ratio of external to internal branch lengths, the slope of the LTT plot and the Colless tree imbalance from the empirical tree are implausible under the constant size coalescent.

  The posterior predictive distributions distributions can also be visualised in R or Excel. We will do this at the end of the next section.

## Assessing the adequacy of the exponential growth coalescent in Ebola

Some aspects of the Ebola virus tree are implausible under the constant size coalescent. This is unsurprising because pathogen populations should increase over an infectious outbreak, such that a constant size model is inappropriate. In contrast, the exponential growth coalescent assumes that the pathogen population is increasing exponentially. This model has two parameters, the effective population size at present and the growth rate, known as *ePopSize* and *growthRate* in BEAST. For infectious diseases, these parameters correspond to:

\[
ePopSize = \frac{\phi}{2\lambda}
\]

\[
growthRate = \lambda - \delta
\]

where $\phi$ is the number of infected individuals at present, $\lambda$ is the coalescent rate, and $\delta$ is the rate of becoming uninfectious (due to death or recovery). This parameterisation is useful in an epidemilogical context because one can estimate the basic reproductive number, which is the mean number of secondary cases per infected individual assuming a fully susceptible population:

\[
R_0=\frac{\lambda}{\delta}
\]

However, because *ePopSize* and *growthRate* are compound parameters, it is necessary to know the number of infected individuals at present to infer $R_0$. We will assess the adequacy of this model in BEAST using the same test statistics from the previous section.

9. Follow steps **1.** and **2.** to load the TMA template and Ebola virus tree in BEAUTI.

10. Click on the **Priors** tab and select the **Coalescent Exponential Population**. The display in BEAUTI should look like **Fig. 9**.


[INSERT FIGURE 8 HERE]
**Fig. 9** Display of coalescent exponential in BEAUTI.

11. The Ebola virus tree has branch lengths in units of years. This means that the growth rate can be very large. Leave the default prior for the *ePopSize* parameter. For the *growthRate* the default prior is inappropriate. Set a Uniform distribution and an initial value of 100. To do this click on the dropdown menu highlighted in **Fig. 9**, and click the *initial* button. Set the Value to 100 (**Fig. 10**) and click OK.


[INSERT FIGURE 10 HERE]
**Fig. 10** Setting the starting value for the *growthRate*.

12. Click on the **MCMC** tab and follow the following settings:

  >- **Nr Of Trees** Set this to 100.

  >-  **Rootdir** Type in *tmp_CE*.

  >-  Leave **Value** and **Hosts** empty.

  >- **Burn in Percentage** Set this to 10.

  >- **Master** Clock on *browse* and find the master file called **CE_hetero_sim.xml**.

  >- **Edit statistics** As in step **5.** above, select *Tree Height*, *Time of maximum lineages*, *Slope ratio for LTT plot*, *Colless tree-imbalance*, and *External/Internal ratio* (**Fig. 7**). Click OK.

  >- **Chain Length** Set this to 10,000,000.

  >- Leave everything else with the defaults. Except for **tracelog**. Click on the pencil next to this option and change the **File Name** to **ebola_2014_ce.log** and click OK.

Click on **File**, **Save as** and save the file as **ebola_CE.xml**.

13. Follow step **6.** to run BEAST.

14. After the analysis has run, the *P* values and test statistics will be displayed. I obtained the following values; 0.7 for *Tree Height*, 0.52 for *Time of maximum lineages*, 0.24 for *Slope ratio for LTT plot*, 0.93 for *Colless tree imbalance* and 0.88 for *External/Internal ratio*. If we used the frequentist we would consider that the aspects of the Ebola virus tree that are measured by these test statistics are plausible under the exponential growth coalescent. This is expected because these ebola samples were collected at the very early stages of the 2014 - 2016 West African outbreak. In fact, all the samples were obtained in mid-2014 such that the virus population was probably still growing exponentially.

## Visualising the posterior predictive distribution of test statistics in R

The main output from TMA is a log file with test statistics for the posterior predictive simulations and for the empirical data. For the analyses above, these files have names **out_cc.log** and **out_ce.log** for the constant size coalescent and the exponential growth coalescent models, respectively. We have provided an R script to do this, which can be downloaded [here](to plotting script).
